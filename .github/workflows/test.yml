name: Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  grammar-validation:
    name: Grammar Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install tree-sitter CLI
        run: npm install -g tree-sitter-cli

      - name: Generate parser
        run: tree-sitter generate

      - name: Run grammar tests
        run: tree-sitter test

  nodejs-binding:
    name: Node.js Binding Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Install tree-sitter
        run: npm install tree-sitter

      - name: Run Node.js binding test
        run: node bindings/node/binding_test.js

  python-binding:
    name: Python Binding Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tree-sitter pytest

      - name: Install package
        run: pip install -e .

      - name: Run Python binding tests
        run: python -m pytest bindings/python/tests/ -v

  go-binding:
    name: Go Binding Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run Go binding test
        working-directory: bindings/go
        run: go test -v

  rust-binding:
    name: Rust Binding Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Run Rust binding tests
        run: cargo test --verbose

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: grammar-validation
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install tree-sitter CLI
        run: npm install -g tree-sitter-cli

      - name: Generate parser
        run: tree-sitter generate

      - name: Clone INET repository
        run: git clone https://github.com/inet-framework/inet.git

      - name: Make smoke test executable
        run: chmod +x smoke_test.sh

      - name: Run smoke test on INET src directory
        run: ./smoke_test.sh ned inet/src
